<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="./style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>検索結果</title>
</head>
<body id="search-body">

  <div class="container">
    <h1 style="text-align: center; margin-bottom: 60px;">検索</h1>
    <form id="searchForm" onsubmit="return false;" style="max-width:600px;margin:20px auto 0 auto;">
      <h2>経穴検索</h2>
      <div class="search-controls">
        <input type="text" id="searchBox" placeholder="経穴名 または 関連ワード" required />
        <div class="button-container">
          <button id="searchBtn" type="button">検索</button>
        </div>
      </div>
    </form>
    <div id="results">検索ワードを入力してください。</div>
  </div>

  <script>
    // キーワードにマッチした部分を赤字＆下線で強調する関数
    function highlightKeyword(text, keyword) {
      if (!keyword) return text;
      const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const regex = new RegExp(escapedKeyword, "gi");
      return text.replace(regex, (match) => `<span style="color:red; text-decoration:underline;">${match}</span>`);
    }

    let questionsData = null;
    let answersData = null;
    const categoryNames = {
      "1": "督脈",
      "2": "任脈",
      "3": "手の太陰肺経",
      "4": "手の陽明大腸経",
      "5": "足の陽明胃経",
      "6": "足の太陰脾経",
      "7": "手の少陰心経",
      "8": "手の太陽小腸経",
      "9": "足の太陽膀胱経",
      "10": "足の少陰腎経",
      "11": "手の厥陰心包経",
      "12": "手の少陽三焦経",
      "13": "足の少陽胆経",
      "14": "足の厥陰肝経",
      "15": "奇穴",
    };

    async function fetchData() {
      if (questionsData && answersData) return;
      // 1.json～15.jsonをカテゴリごとに格納
      questionsData = {};
      const files = Array.from({length: 15}, (_, i) => `json/${i+1}.json`);
      for (let i = 0; i < files.length; i++) {
        const catNum = String(i+1);
        try {
          const res = await fetch(files[i]);
          if (!res.ok) continue;
          const data = await res.json();
          if (Array.isArray(data)) {
            questionsData[catNum] = data;
          } else if (typeof data === 'object') {
            // オブジェクトの場合は全配列を結合
            let arr = [];
            Object.values(data).forEach(a => { if (Array.isArray(a)) arr.push(...a); });
            questionsData[catNum] = arr;
          } else {
            questionsData[catNum] = [];
          }
        } catch(e) { questionsData[catNum] = []; }
      }
      // choices.jsonは従来通り
      const aRes = await fetch("json/choices.json");
      answersData = await aRes.json();
    }

    // note, text のみ表示する関数（共通化）
    function getNotesHtml(q, keyword) {
      let html = "";
      Object.keys(q)
        .filter(k => k.startsWith("note"))
        .sort((a, b) => (a === 'note' ? -1 : b === 'note' ? 1 : a.localeCompare(b, undefined, { numeric: true })))
        .forEach(k => {
          if (q[k]) html += `<div class="note-text">・${highlightKeyword(q[k], keyword)}</div>`;
        });
      return html;
    }
    function getTextHtml(q, keyword) {
      if (Array.isArray(q.text) && q.text.length > 0) {
        return `<div class="text-text">・${highlightKeyword(q.text[0], keyword)}</div>`;
      } else if (q.text) {
        return `<div class="text-text">・${highlightKeyword(q.text, keyword)}</div>`;
      }
      return "";
    }
    function createResultBox(q, keyword, isHidden) {
      return `<strong>${highlightKeyword(q.id, keyword)}${isHidden ? "（参考）" : ""}</strong><br>
        ${getTextHtml(q, keyword)}
        ${getNotesHtml(q, keyword)}`;
    }
    // 検索対象フィールドをまとめて取得する関数
    function getSearchFields(q) {
      let fields = [q.id];
      if (Array.isArray(q.text)) fields = fields.concat(q.text);
      else if (q.text) fields.push(q.text);
      Object.keys(q).forEach(k => {
        if (k.startsWith('note') && q[k]) fields.push(q[k]);
      });
      if (q.data && typeof q.data === 'string' && q.data.trim()) fields.push(q.data);
      return fields;
    }

    async function doSearch(keyword) {

      await fetchData();
      const results = document.getElementById("results");
      results.innerHTML = "";
      keyword = keyword.trim();
      if (!keyword) {
        results.innerHTML = "検索ワードを入力してください。";
        return;
      }

      // AND検索用にキーワードを空白で分割
      let keywords = keyword.split(/\s+/).filter(Boolean);
      // スペースが全く含まれない場合は、全角・半角スペースで分割できなければ1文字ずつ分割も追加
      let altKeywords = [];
      if (keywords.length === 1 && keyword.length > 1 && !/\s/.test(keyword)) {
        // 例: "大腸経要穴" → ["大腸経", "要穴"] になるような分割は困難なので、2文字以上の部分一致も考慮
        // まず2文字以上の部分一致を優先（例: "大腸経", "要穴"）
        // ただし、現状は1文字ずつ分割でAND検索も追加
        altKeywords = keyword.split("");
      }

      function getConcatFields(q) {
        return getSearchFields(q).join("");
      }

      // --- 経脈名検索時の特別表示（カテゴリ一覧＋部分一致note等） ---
      const meridianMap = {
        "督脈": "督脈",
        "任脈": "任脈",
        "肺経": "手の太陰肺経",
        "大腸経": "手の陽明大腸経",
        "胃経": "足の陽明胃経",
        "脾経": "足の太陰脾経",
        "心経": "手の少陰心経",
        "小腸経": "手の太陽小腸経",
        "膀胱経": "足の太陽膀胱経",
        "腎経": "足の少陰腎経",
        "心包経": "手の厥陰心包経",
        "三焦経": "手の少陽三焦経",
        "胆経": "足の少陽胆経",
        "肝経": "足の厥陰肝経"
      };
      if (meridianMap[keyword]) {
        // 1. カテゴリ一覧を表示
        const catEntry = Object.entries(categoryNames).find(([_, name]) => name === meridianMap[keyword]);
        const [catNum] = catEntry || [];
        const list = questionsData[catNum] || [];
        const shownIds = new Set();
        if (list.length > 0) {
          results.innerHTML = `<h2>${meridianMap[keyword]} の経穴一覧</h2>`;
          for (const q of list) {
            const isHidden = q.hidden === true;
            const box = document.createElement("div");
            box.innerHTML = createResultBox(q, keyword, isHidden);
            box.className = isHidden ? "result-box hidden-box" : "result-box";
            results.appendChild(box);
            shownIds.add(q.id);
          }
        }
        // 2. note等にキーワードを含む経穴を全カテゴリから抽出
        const haystacksList = [];
        Object.values(questionsData).forEach(arr => {
          arr.forEach(q => {
            haystacksList.push({ q, fields: getSearchFields(q) });
          });
        });
        // AND検索: 全キーワードが含まれる or 連結キーワードが含まれるもの
        const noteResults = haystacksList.filter(obj => {
          const concat = obj.fields.join("");
          // 1. 連結キーワードが含まれる
          if (concat.includes(keyword)) return true;
          // 2. 分割キーワードすべて含む
          if (keywords.every(kw => concat.includes(kw))) return true;
          // 3. スペースがない場合は1文字ずつANDも許容
          if (altKeywords.length > 1 && altKeywords.every(kw => concat.includes(kw))) return true;
          return false;
        });
        // 3. カテゴリ一覧で既に表示済みの経穴IDを除外
        const uniqueResults = noteResults.filter(obj => !shownIds.has(obj.q.id));
        // 4. 重複しないnoteResultsのみ追加表示
        uniqueResults.forEach(obj => {
          const isHidden = obj.q.hidden === true;
          const box = document.createElement("div");
          box.className = isHidden ? "result-box hidden-box" : "result-box";
          box.innerHTML = createResultBox(obj.q, keyword, isHidden);
          results.appendChild(box);
        });
        return;
      }
      // --- 通常の全文検索（ID・text・note・data） ---
      const resultSet = new Map();
      Object.keys(questionsData).forEach(cat => {
        questionsData[cat].forEach(q => {
          const concat = getConcatFields(q);
          // 1. 連結キーワードが含まれる
          if (concat.includes(keyword)) {
            resultSet.set(q.id, { q });
            return;
          }
          // 2. 分割キーワードすべて含む
          if (keywords.every(kw => concat.includes(kw))) {
            resultSet.set(q.id, { q });
            return;
          }
          // 3. スペースがない場合は1文字ずつANDも許容
          if (altKeywords.length > 1 && altKeywords.every(kw => concat.includes(kw))) {
            resultSet.set(q.id, { q });
            return;
          }
        });
      });
      if (resultSet.size > 0) {
        results.innerHTML = `<h2>「${keyword}」に関連する経穴</h2>`;
        for (const { q } of resultSet.values()) {
          const isHidden = q.hidden === true;
          const box = document.createElement("div");
          box.className = isHidden ? "result-box hidden-box" : "result-box";
          box.innerHTML = createResultBox(q, keyword, isHidden);
          results.appendChild(box);
        }
        return;
      } else {
        results.innerHTML = `<div class=\"result-box\">「${keyword}」は見つかりませんでした。</div>`;
      }
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
      const kw = document.getElementById("searchBox").value;
      doSearch(kw);
    });
    document.getElementById("searchBox").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        doSearch(e.target.value);
      }
    });

    // URLパラメータがあれば初期表示
    const params = new URLSearchParams(location.search);
    const initialKeyword = params.get("keyword") || "";
    const mode = params.get("mode") || "";
    if (mode === "meridian" && initialKeyword) {
      // 経脈プルダウンから遷移時はカテゴリ一覧を必ず表示
      showCategoryList(initialKeyword);
      document.getElementById("searchBox").value = initialKeyword;
    } else if (initialKeyword) {
      document.getElementById("searchBox").value = initialKeyword;
      doSearch(initialKeyword);
    }

    // 経脈カテゴリ一覧を表示する関数
    async function showCategoryList(categoryName) {
      await fetchData();
      const results = document.getElementById("results");
      results.innerHTML = "";
      const catEntry = Object.entries(categoryNames).find(([_, name]) => name === categoryName);
      if (!catEntry) {
        results.innerHTML = `<div class=\"result-box\">「${categoryName}」の経穴データが見つかりません。</div>`;
        return;
      }
      const [catNum] = catEntry;
      const list = questionsData[catNum] || [];
      if (list.length === 0) {
        results.innerHTML = `<div class=\"result-box\">「${categoryName}」の経穴データが見つかりません。</div>`;
        return;
      }
      results.innerHTML = `<h2>${categoryName} の経穴一覧</h2>`;
      const keyword = "";
      for (const q of list) {
        const box = document.createElement("div");
        const isHidden = q.hidden === true;
        box.className = isHidden ? "result-box hidden-box" : "result-box";
        box.innerHTML = createResultBox(q, keyword, isHidden);
        results.appendChild(box);
      }
    }
  </script>

    <div class="back-button-container">
      <a href="index.html">
        <button class="category-back-button">カテゴリ選択に戻る</button>
      </a>
    </div>
  </div>
</body>
</html>